import "pe"
import "math"

rule packed
{
	meta: 
		description = "Malware Analysis Homework 7 part 3 - Generic Malware Detector"
		author = "Himanshu Londhe"
	
	strings: 
			
		$i1 = "hSeVVK"
		$i2 = "UPX0"
		$i3 = "BROWSER_FB_DocumentComplete"
		$i4 = "So long!	"
		$i5 = "Rj@j"
		$i6 = "KyUffThOkYwRRtgPP"
		$i7 = "rundll.exe"
		$c1 = "__C_specific_handler" fullword ascii nocase
		
		
	condition:
		uint16(0) == 0x5a4d and 
		
		(not $c1) and
		
		for any i in (0..pe.number_of_sections - 1):
			(math.entropy(pe.sections[i].raw_data_offset, pe.sections[i].raw_data_size) >= 6.9)
			
		or 
		for any j in (0..pe.number_of_sections - 1):
			(math.entropy(pe.sections[j].raw_data_offset, pe.sections[j].raw_data_size) == 0)
			
		or pe.number_of_sections >= 10
		
		or pe.number_of_sections < 1
		
		or 
		pe.number_of_rva_and_sizes != 16
		
		or 
		for any k in (0..pe.number_of_sections - 1): 
			(pe.sections[k].raw_data_size == 0)
			
		or
		for any x in (0..pe.number_of_sections - 1): 
			(((pe.sections[x].virtual_size)\(pe.sections[x].raw_data_size)) > 10) 
			
		or 
		pe.BYTES_REVERSED_HI == 1
		
		or 
		for any y in (0..pe.number_of_sections -1):
			(pe.resources[y].language == 0)
			
		or 
		pe.pointer_to_symbol_table > 0 
		
		or 
		any of($i*)
}

